name: STG Environment Wake Up

on:
  workflow_dispatch:
    inputs:
      duration:
        description: '起動時間（時間後に自動停止）'
        required: true
        default: '4'
        type: choice
        options:
        - '1'
        - '2'
        - '4'
        - '8'
        - '24'
      purpose:
        description: '使用目的'
        required: false
        type: string
        default: 'テスト・開発作業'
  
  # Webhook経由での起動も可能
  repository_dispatch:
    types: [wake-stg]

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  check-if-already-running:
    runs-on: ubuntu-latest
    environment: Preview
    outputs:
      is_running: ${{ steps.check_status.outputs.status }}
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ env.AWS_REGION }}

      - name: 🔍 Check Current Status
        id: check_status
        run: |
          echo "現在のSTG環境状態を確認中..."
          
          # Frontend service status
          FRONTEND_COUNT=$(aws ecs describe-services \
            --cluster stg-front \
            --services stg-front-service \
            --query 'services[0].desiredCount' \
            --output text 2>/dev/null || echo "0")
          
          # Backend service status  
          BACKEND_COUNT=$(aws ecs describe-services \
            --cluster stg-api \
            --services stg-api-service \
            --query 'services[0].desiredCount' \
            --output text 2>/dev/null || echo "0")
          
          echo "Frontend desired count: $FRONTEND_COUNT"
          echo "Backend desired count: $BACKEND_COUNT"
          
          if [ "$FRONTEND_COUNT" = "1" ] && [ "$BACKEND_COUNT" = "1" ]; then
            echo "status=running" >> $GITHUB_OUTPUT
            echo "✅ STG環境は既に起動中です"
          else
            echo "status=stopped" >> $GITHUB_OUTPUT
            echo "🛑 STG環境は停止中です"
          fi

  already-running:
    runs-on: ubuntu-latest
    needs: check-if-already-running
    if: needs.check-if-already-running.outputs.is_running == 'running'
    
    steps:
      - name: ℹ️ Already Running
        run: |
          echo "✅ STG環境は既に起動中です"
          echo "現在のサービス状態を確認してください"

  wake-up-stg:
    runs-on: ubuntu-latest
    environment: Preview
    needs: check-if-already-running
    if: needs.check-if-already-running.outputs.is_running == 'stopped'
    
    steps:
      - name: 🚀 STG Wake Up Summary
        run: |
          echo "🎯 STG環境起動開始"
          echo "⏰ 起動時間: ${{ github.event.inputs.duration || '4' }}時間"
          echo "📝 使用目的: ${{ github.event.inputs.purpose || 'API経由起動' }}"
          echo "💰 想定コスト: ~$0.10-2"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ env.AWS_REGION }}

      - name: 🚀 Start ECS Services
        run: |
          echo "🚀 ECSサービス起動中..."
          
          # Start Frontend service
          echo "Frontend service起動中..."
          aws ecs update-service \
            --cluster stg-front \
            --service stg-front-service \
            --desired-count 1
          
          # Start Backend service
          echo "Backend service起動中..."
          aws ecs update-service \
            --cluster stg-api \
            --service stg-api-service \
            --desired-count 1
          
          echo "✅ ECSサービス起動コマンド完了"

      - name: ⏳ Wait for Services to Start
        run: |
          echo "⏳ サービス起動完了まで待機中..."
          
          # Wait for frontend service
          echo "Frontend service起動待機中..."
          aws ecs wait services-stable \
            --cluster stg-front \
            --services stg-front-service \
            --cli-read-timeout 300 \
            --cli-connect-timeout 60 || echo "Frontend timeout (続行)"
          
          # Wait for backend service
          echo "Backend service起動待機中..."
          aws ecs wait services-stable \
            --cluster stg-api \
            --services stg-api-service \
            --cli-read-timeout 300 \
            --cli-connect-timeout 60 || echo "Backend timeout (続行)"

      - name: 🔍 Get Service URLs
        id: get_urls
        run: |
          echo "🔍 サービスURLを取得中..."
          echo "⏳ タスクのネットワーク設定完了まで少し待機..."
          sleep 30
          
          # Frontend IP取得を複数回試行
          FRONTEND_IP=""
          for i in {1..5}; do
            echo "Frontend IP取得試行 $i/5..."
            
            FRONTEND_TASK_ARN=$(aws ecs list-tasks \
              --cluster stg-front \
              --service-name stg-front-service \
              --query 'taskArns[0]' \
              --output text 2>/dev/null || echo "")
            
            echo "Frontend Task ARN: $FRONTEND_TASK_ARN"
            
            if [ "$FRONTEND_TASK_ARN" != "" ] && [ "$FRONTEND_TASK_ARN" != "None" ] && [ "$FRONTEND_TASK_ARN" != "null" ]; then
              # タスクの詳細を取得
              TASK_DETAIL=$(aws ecs describe-tasks \
                --cluster stg-front \
                --tasks $FRONTEND_TASK_ARN \
                --query 'tasks[0]' \
                --output json 2>/dev/null || echo "{}")
              
              echo "Task detail keys: $(echo "$TASK_DETAIL" | jq -r 'keys[]' 2>/dev/null || echo 'JSON parse failed')"
              
              # ネットワークインターフェースIDを取得
              FRONTEND_ENI=$(echo "$TASK_DETAIL" | jq -r '.attachments[0].details[] | select(.name=="networkInterfaceId") | .value' 2>/dev/null || echo "")
              
              echo "Frontend ENI: $FRONTEND_ENI"
              
              if [ "$FRONTEND_ENI" != "" ] && [ "$FRONTEND_ENI" != "null" ]; then
                # パブリックIPを取得
                FRONTEND_IP=$(aws ec2 describe-network-interfaces \
                  --network-interface-ids $FRONTEND_ENI \
                  --query 'NetworkInterfaces[0].Association.PublicIp' \
                  --output text 2>/dev/null || echo "")
                
                echo "Frontend IP: $FRONTEND_IP"
                
                if [ "$FRONTEND_IP" != "" ] && [ "$FRONTEND_IP" != "None" ] && [ "$FRONTEND_IP" != "null" ]; then
                  echo "✅ Frontend IP取得成功: $FRONTEND_IP"
                  break
                fi
              fi
            fi
            
            if [ $i -lt 5 ]; then
              echo "⏳ 30秒待機してリトライ..."
              sleep 30
            fi
          done
          
          # Backend IP取得を複数回試行
          BACKEND_IP=""
          for i in {1..5}; do
            echo "Backend IP取得試行 $i/5..."
            
            BACKEND_TASK_ARN=$(aws ecs list-tasks \
              --cluster stg-api \
              --service-name stg-api-service \
              --query 'taskArns[0]' \
              --output text 2>/dev/null || echo "")
            
            echo "Backend Task ARN: $BACKEND_TASK_ARN"
            
            if [ "$BACKEND_TASK_ARN" != "" ] && [ "$BACKEND_TASK_ARN" != "None" ] && [ "$BACKEND_TASK_ARN" != "null" ]; then
              # タスクの詳細を取得
              TASK_DETAIL=$(aws ecs describe-tasks \
                --cluster stg-api \
                --tasks $BACKEND_TASK_ARN \
                --query 'tasks[0]' \
                --output json 2>/dev/null || echo "{}")
              
              echo "Task detail keys: $(echo "$TASK_DETAIL" | jq -r 'keys[]' 2>/dev/null || echo 'JSON parse failed')"
              
              # ネットワークインターフェースIDを取得
              BACKEND_ENI=$(echo "$TASK_DETAIL" | jq -r '.attachments[0].details[] | select(.name=="networkInterfaceId") | .value' 2>/dev/null || echo "")
              
              echo "Backend ENI: $BACKEND_ENI"
              
              if [ "$BACKEND_ENI" != "" ] && [ "$BACKEND_ENI" != "null" ]; then
                # パブリックIPを取得
                BACKEND_IP=$(aws ec2 describe-network-interfaces \
                  --network-interface-ids $BACKEND_ENI \
                  --query 'NetworkInterfaces[0].Association.PublicIp' \
                  --output text 2>/dev/null || echo "")
                
                echo "Backend IP: $BACKEND_IP"
                
                if [ "$BACKEND_IP" != "" ] && [ "$BACKEND_IP" != "None" ] && [ "$BACKEND_IP" != "null" ]; then
                  echo "✅ Backend IP取得成功: $BACKEND_IP"
                  break
                fi
              fi
            fi
            
            if [ $i -lt 5 ]; then
              echo "⏳ 30秒待機してリトライ..."
              sleep 30
            fi
          done
          
          # 結果をGitHub Outputに設定
          echo "frontend_ip=$FRONTEND_IP" >> $GITHUB_OUTPUT
          echo "backend_ip=$BACKEND_IP" >> $GITHUB_OUTPUT

      - name: 📋 Wake Up Complete
        run: |
          echo ""
          echo "🎉 STG環境起動完了!"
          echo "⏰ 起動時間: ${{ github.event.inputs.duration || '4' }}時間"
          echo "📝 使用目的: ${{ github.event.inputs.purpose || 'API経由起動' }}"
          echo ""
          
          FRONTEND_IP="${{ steps.get_urls.outputs.frontend_ip }}"
          BACKEND_IP="${{ steps.get_urls.outputs.backend_ip }}"
          
          if [ "$FRONTEND_IP" != "" ] && [ "$FRONTEND_IP" != "null" ]; then
            echo "🌐 Frontend URL: http://$FRONTEND_IP:3000"
          else
            echo "⚠️ Frontend IP取得に失敗"
            echo "📋 手動確認コマンド:"
            echo "aws ecs list-tasks --cluster stg-front --service-name stg-front-service"
          fi
          
          if [ "$BACKEND_IP" != "" ] && [ "$BACKEND_IP" != "null" ]; then
            echo "🌐 Backend URL: http://$BACKEND_IP:5050"
          else
            echo "⚠️ Backend IP取得に失敗"
            echo "📋 手動確認コマンド:"
            echo "aws ecs list-tasks --cluster stg-api --service-name stg-api-service"
          fi
          
          echo ""
          echo "📋 CloudFlare設定更新:"
          echo "1. CloudFlareダッシュボードにログイン"
          echo "2. DNS設定でstg.smartao.jpのAレコードを更新"
          if [ "$FRONTEND_IP" != "" ] && [ "$FRONTEND_IP" != "null" ]; then
            echo "3. 新しいIP: $FRONTEND_IP"
          else
            echo "3. IPアドレス: 手動で確認が必要"
          fi
          echo ""
          echo "🛑 使用後は必ず停止してください:"
          echo "GitHub Actions: 'STG Environment Sleep' ワークフロー実行"
          echo ""
          echo "💰 想定コスト: ${{ github.event.inputs.duration || '4' }}時間で約$0.40-2"
          echo ""
          echo "🔧 トラブルシューティング:"
          echo "IPが取得できない場合は、数分待ってから以下を実行:"
          echo "GitHub Actions > 'STG Environment Wake Up' を再実行" 