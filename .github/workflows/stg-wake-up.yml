name: STG Environment Wake Up

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'èµ·å‹•æ™‚é–“ï¼ˆæ™‚é–“å¾Œã«è‡ªå‹•åœæ­¢ï¼‰'
        required: true
        default: '4'
        type: choice
        options:
        - '1'
        - '2'
        - '4'
        - '8'
        - '24'
      purpose:
        description: 'ä½¿ç”¨ç›®çš„'
        required: false
        type: string
        default: 'ãƒ†ã‚¹ãƒˆãƒ»é–‹ç™ºä½œæ¥­'
  
  # WebhookçµŒç”±ã§ã®èµ·å‹•ã‚‚å¯èƒ½
  repository_dispatch:
    types: [wake-stg]

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  check-if-already-running:
    runs-on: ubuntu-latest
    environment: Preview
    outputs:
      is_running: ${{ steps.check_status.outputs.status }}
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ env.AWS_REGION }}

      - name: ğŸ” Check Current Status
        id: check_status
        run: |
          echo "ç¾åœ¨ã®STGç’°å¢ƒçŠ¶æ…‹ã‚’ç¢ºèªä¸­..."
          
          # Frontend service status
          FRONTEND_COUNT=$(aws ecs describe-services \
            --cluster stg-front \
            --services stg-front-service \
            --query 'services[0].desiredCount' \
            --output text 2>/dev/null || echo "0")
          
          # Backend service status  
          BACKEND_COUNT=$(aws ecs describe-services \
            --cluster stg-api \
            --services stg-api-service \
            --query 'services[0].desiredCount' \
            --output text 2>/dev/null || echo "0")
          
          echo "Frontend desired count: $FRONTEND_COUNT"
          echo "Backend desired count: $BACKEND_COUNT"
          
          if [ "$FRONTEND_COUNT" = "1" ] && [ "$BACKEND_COUNT" = "1" ]; then
            echo "status=running" >> $GITHUB_OUTPUT
            echo "âœ… STGç’°å¢ƒã¯æ—¢ã«èµ·å‹•ä¸­ã§ã™"
          else
            echo "status=stopped" >> $GITHUB_OUTPUT
            echo "ğŸ›‘ STGç’°å¢ƒã¯åœæ­¢ä¸­ã§ã™"
          fi

  already-running:
    runs-on: ubuntu-latest
    needs: check-if-already-running
    if: needs.check-if-already-running.outputs.is_running == 'running'
    
    steps:
      - name: â„¹ï¸ Already Running
        run: |
          echo "âœ… STGç’°å¢ƒã¯æ—¢ã«èµ·å‹•ä¸­ã§ã™"
          echo "ç¾åœ¨ã®ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„"

  wake-up-stg:
    runs-on: ubuntu-latest
    environment: Preview
    needs: check-if-already-running
    if: needs.check-if-already-running.outputs.is_running == 'stopped'
    
    steps:
      - name: ğŸš€ STG Wake Up Summary
        run: |
          echo "ğŸ¯ STGç’°å¢ƒèµ·å‹•é–‹å§‹"
          echo "â° èµ·å‹•æ™‚é–“: ${{ github.event.inputs.duration || '4' }}æ™‚é–“"
          echo "ğŸ“ ä½¿ç”¨ç›®çš„: ${{ github.event.inputs.purpose || 'APIçµŒç”±èµ·å‹•' }}"
          echo "ğŸ’° æƒ³å®šã‚³ã‚¹ãƒˆ: ~$0.10-2"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ env.AWS_REGION }}

      - name: ğŸš€ Start ECS Services
        run: |
          echo "ğŸš€ ECSã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•ä¸­..."
          
          # Start Frontend service
          echo "Frontend serviceèµ·å‹•ä¸­..."
          aws ecs update-service \
            --cluster stg-front \
            --service stg-front-service \
            --desired-count 1
          
          # Start Backend service
          echo "Backend serviceèµ·å‹•ä¸­..."
          aws ecs update-service \
            --cluster stg-api \
            --service stg-api-service \
            --desired-count 1
          
          echo "âœ… ECSã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•ã‚³ãƒãƒ³ãƒ‰å®Œäº†"

      - name: â³ Wait for Services to Start
        run: |
          echo "â³ ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•å®Œäº†ã¾ã§å¾…æ©Ÿä¸­..."
          
          # Wait for frontend service
          echo "Frontend serviceèµ·å‹•å¾…æ©Ÿä¸­..."
          aws ecs wait services-stable \
            --cluster stg-front \
            --services stg-front-service \
            --cli-read-timeout 300 \
            --cli-connect-timeout 60 || echo "Frontend timeout (ç¶šè¡Œ)"
          
          # Wait for backend service
          echo "Backend serviceèµ·å‹•å¾…æ©Ÿä¸­..."
          aws ecs wait services-stable \
            --cluster stg-api \
            --services stg-api-service \
            --cli-read-timeout 300 \
            --cli-connect-timeout 60 || echo "Backend timeout (ç¶šè¡Œ)"

      - name: ğŸ” Get Service URLs
        id: get_urls
        run: |
          echo "ğŸ” ã‚µãƒ¼ãƒ“ã‚¹URLã‚’å–å¾—ä¸­..."
          echo "â³ ã‚¿ã‚¹ã‚¯ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šå®Œäº†ã¾ã§å°‘ã—å¾…æ©Ÿ..."
          sleep 30
          
          # Frontend IPå–å¾—ã‚’è¤‡æ•°å›è©¦è¡Œ
          FRONTEND_IP=""
          for i in {1..5}; do
            echo "Frontend IPå–å¾—è©¦è¡Œ $i/5..."
            
            FRONTEND_TASK_ARN=$(aws ecs list-tasks \
              --cluster stg-front \
              --service-name stg-front-service \
              --query 'taskArns[0]' \
              --output text 2>/dev/null || echo "")
            
            echo "Frontend Task ARN: $FRONTEND_TASK_ARN"
            
            if [ "$FRONTEND_TASK_ARN" != "" ] && [ "$FRONTEND_TASK_ARN" != "None" ] && [ "$FRONTEND_TASK_ARN" != "null" ]; then
              # ã‚¿ã‚¹ã‚¯ã®è©³ç´°ã‚’å–å¾—
              TASK_DETAIL=$(aws ecs describe-tasks \
                --cluster stg-front \
                --tasks $FRONTEND_TASK_ARN \
                --query 'tasks[0]' \
                --output json 2>/dev/null || echo "{}")
              
              echo "Task detail keys: $(echo "$TASK_DETAIL" | jq -r 'keys[]' 2>/dev/null || echo 'JSON parse failed')"
              
              # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹IDã‚’å–å¾—
              FRONTEND_ENI=$(echo "$TASK_DETAIL" | jq -r '.attachments[0].details[] | select(.name=="networkInterfaceId") | .value' 2>/dev/null || echo "")
              
              echo "Frontend ENI: $FRONTEND_ENI"
              
              if [ "$FRONTEND_ENI" != "" ] && [ "$FRONTEND_ENI" != "null" ]; then
                # ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚’å–å¾—
                FRONTEND_IP=$(aws ec2 describe-network-interfaces \
                  --network-interface-ids $FRONTEND_ENI \
                  --query 'NetworkInterfaces[0].Association.PublicIp' \
                  --output text 2>/dev/null || echo "")
                
                echo "Frontend IP: $FRONTEND_IP"
                
                if [ "$FRONTEND_IP" != "" ] && [ "$FRONTEND_IP" != "None" ] && [ "$FRONTEND_IP" != "null" ]; then
                  echo "âœ… Frontend IPå–å¾—æˆåŠŸ: $FRONTEND_IP"
                  break
                fi
              fi
            fi
            
            if [ $i -lt 5 ]; then
              echo "â³ 30ç§’å¾…æ©Ÿã—ã¦ãƒªãƒˆãƒ©ã‚¤..."
              sleep 30
            fi
          done
          
          # Backend IPå–å¾—ã‚’è¤‡æ•°å›è©¦è¡Œ
          BACKEND_IP=""
          for i in {1..5}; do
            echo "Backend IPå–å¾—è©¦è¡Œ $i/5..."
            
            BACKEND_TASK_ARN=$(aws ecs list-tasks \
              --cluster stg-api \
              --service-name stg-api-service \
              --query 'taskArns[0]' \
              --output text 2>/dev/null || echo "")
            
            echo "Backend Task ARN: $BACKEND_TASK_ARN"
            
            if [ "$BACKEND_TASK_ARN" != "" ] && [ "$BACKEND_TASK_ARN" != "None" ] && [ "$BACKEND_TASK_ARN" != "null" ]; then
              # ã‚¿ã‚¹ã‚¯ã®è©³ç´°ã‚’å–å¾—
              TASK_DETAIL=$(aws ecs describe-tasks \
                --cluster stg-api \
                --tasks $BACKEND_TASK_ARN \
                --query 'tasks[0]' \
                --output json 2>/dev/null || echo "{}")
              
              echo "Task detail keys: $(echo "$TASK_DETAIL" | jq -r 'keys[]' 2>/dev/null || echo 'JSON parse failed')"
              
              # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹IDã‚’å–å¾—
              BACKEND_ENI=$(echo "$TASK_DETAIL" | jq -r '.attachments[0].details[] | select(.name=="networkInterfaceId") | .value' 2>/dev/null || echo "")
              
              echo "Backend ENI: $BACKEND_ENI"
              
              if [ "$BACKEND_ENI" != "" ] && [ "$BACKEND_ENI" != "null" ]; then
                # ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚’å–å¾—
                BACKEND_IP=$(aws ec2 describe-network-interfaces \
                  --network-interface-ids $BACKEND_ENI \
                  --query 'NetworkInterfaces[0].Association.PublicIp' \
                  --output text 2>/dev/null || echo "")
                
                echo "Backend IP: $BACKEND_IP"
                
                if [ "$BACKEND_IP" != "" ] && [ "$BACKEND_IP" != "None" ] && [ "$BACKEND_IP" != "null" ]; then
                  echo "âœ… Backend IPå–å¾—æˆåŠŸ: $BACKEND_IP"
                  break
                fi
              fi
            fi
            
            if [ $i -lt 5 ]; then
              echo "â³ 30ç§’å¾…æ©Ÿã—ã¦ãƒªãƒˆãƒ©ã‚¤..."
              sleep 30
            fi
          done
          
          # çµæœã‚’GitHub Outputã«è¨­å®š
          echo "frontend_ip=$FRONTEND_IP" >> $GITHUB_OUTPUT
          echo "backend_ip=$BACKEND_IP" >> $GITHUB_OUTPUT

      - name: ğŸ“‹ Wake Up Complete
        run: |
          echo ""
          echo "ğŸ‰ STGç’°å¢ƒèµ·å‹•å®Œäº†!"
          echo "â° èµ·å‹•æ™‚é–“: ${{ github.event.inputs.duration || '4' }}æ™‚é–“"
          echo "ğŸ“ ä½¿ç”¨ç›®çš„: ${{ github.event.inputs.purpose || 'APIçµŒç”±èµ·å‹•' }}"
          echo ""
          
          FRONTEND_IP="${{ steps.get_urls.outputs.frontend_ip }}"
          BACKEND_IP="${{ steps.get_urls.outputs.backend_ip }}"
          
          if [ "$FRONTEND_IP" != "" ] && [ "$FRONTEND_IP" != "null" ]; then
            echo "ğŸŒ Frontend URL: http://$FRONTEND_IP:3000"
          else
            echo "âš ï¸ Frontend IPå–å¾—ã«å¤±æ•—"
            echo "ğŸ“‹ æ‰‹å‹•ç¢ºèªã‚³ãƒãƒ³ãƒ‰:"
            echo "aws ecs list-tasks --cluster stg-front --service-name stg-front-service"
          fi
          
          if [ "$BACKEND_IP" != "" ] && [ "$BACKEND_IP" != "null" ]; then
            echo "ğŸŒ Backend URL: http://$BACKEND_IP:5050"
          else
            echo "âš ï¸ Backend IPå–å¾—ã«å¤±æ•—"
            echo "ğŸ“‹ æ‰‹å‹•ç¢ºèªã‚³ãƒãƒ³ãƒ‰:"
            echo "aws ecs list-tasks --cluster stg-api --service-name stg-api-service"
          fi
          
          echo ""
          echo "ğŸ“‹ CloudFlareè¨­å®šæ›´æ–°:"
          echo "1. CloudFlareãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒ­ã‚°ã‚¤ãƒ³"
          echo "2. DNSè¨­å®šã§stg.smartao.jpã®Aãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°"
          if [ "$FRONTEND_IP" != "" ] && [ "$FRONTEND_IP" != "null" ]; then
            echo "3. æ–°ã—ã„IP: $FRONTEND_IP"
          else
            echo "3. IPã‚¢ãƒ‰ãƒ¬ã‚¹: æ‰‹å‹•ã§ç¢ºèªãŒå¿…è¦"
          fi
          echo ""
          echo "ğŸ›‘ ä½¿ç”¨å¾Œã¯å¿…ãšåœæ­¢ã—ã¦ãã ã•ã„:"
          echo "GitHub Actions: 'STG Environment Sleep' ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ"
          echo ""
          echo "ğŸ’° æƒ³å®šã‚³ã‚¹ãƒˆ: ${{ github.event.inputs.duration || '4' }}æ™‚é–“ã§ç´„$0.40-2"
          echo ""
          echo "ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°:"
          echo "IPãŒå–å¾—ã§ããªã„å ´åˆã¯ã€æ•°åˆ†å¾…ã£ã¦ã‹ã‚‰ä»¥ä¸‹ã‚’å®Ÿè¡Œ:"
          echo "GitHub Actions > 'STG Environment Wake Up' ã‚’å†å®Ÿè¡Œ" 