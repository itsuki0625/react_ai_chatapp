name: STG Environment Sleep

on:
  workflow_dispatch:
    inputs:
      confirm_stop:
        description: 'STGç’°å¢ƒã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ'
        required: true
        default: 'false'
        type: choice
        options:
        - 'false'
        - 'true'

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  sleep-stg:
    runs-on: ubuntu-latest
    environment: Preview
    if: ${{ github.event.inputs.confirm_stop == 'true' }}
    
    steps:
      - name: ğŸ›‘ STG Sleep Summary
        run: |
          echo "ğŸ›‘ STGç’°å¢ƒåœæ­¢é–‹å§‹"
          echo "ğŸ’° ã‚³ã‚¹ãƒˆå‰Šæ¸›åŠ¹æœ: åœæ­¢å¾Œã¯æœˆé¡$5ã®ã¿"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ env.AWS_REGION }}

      - name: ğŸ” Check Current Status
        id: check_status
        run: |
          echo "ç¾åœ¨ã®STGç’°å¢ƒçŠ¶æ…‹ã‚’ç¢ºèªä¸­..."
          
          # Frontend service status
          FRONTEND_COUNT=$(aws ecs describe-services \
            --cluster stg-front \
            --services stg-front-service \
            --query 'services[0].desiredCount' \
            --output text 2>/dev/null || echo "0")
          
          # Backend service status  
          BACKEND_COUNT=$(aws ecs describe-services \
            --cluster stg-api \
            --services stg-api-service \
            --query 'services[0].desiredCount' \
            --output text 2>/dev/null || echo "0")
          
          echo "Frontend desired count: $FRONTEND_COUNT"
          echo "Backend desired count: $BACKEND_COUNT"
          
          if [ "$FRONTEND_COUNT" = "0" ] && [ "$BACKEND_COUNT" = "0" ]; then
            echo "status=stopped" >> $GITHUB_OUTPUT
            echo "ğŸ›‘ STGç’°å¢ƒã¯æ—¢ã«åœæ­¢ä¸­ã§ã™"
          else
            echo "status=running" >> $GITHUB_OUTPUT
            echo "âœ… STGç’°å¢ƒã¯èµ·å‹•ä¸­ã§ã™"
          fi

      - name: ğŸ›‘ Stop ECS Services
        if: steps.check_status.outputs.status == 'running'
        run: |
          echo "ğŸ›‘ ECSã‚µãƒ¼ãƒ“ã‚¹åœæ­¢ä¸­..."
          
          # Stop Frontend service
          echo "Frontend serviceåœæ­¢ä¸­..."
          aws ecs update-service \
            --cluster stg-front \
            --service stg-front-service \
            --desired-count 0
          
          # Stop Backend service
          echo "Backend serviceåœæ­¢ä¸­..."
          aws ecs update-service \
            --cluster stg-api \
            --service stg-api-service \
            --desired-count 0
          
          echo "âœ… ECSã‚µãƒ¼ãƒ“ã‚¹åœæ­¢ã‚³ãƒãƒ³ãƒ‰å®Œäº†"

      - name: â³ Wait for Services to Stop
        if: steps.check_status.outputs.status == 'running'
        run: |
          echo "â³ ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢å®Œäº†ã¾ã§å¾…æ©Ÿä¸­..."
          
          # Wait for services to scale down
          sleep 30
          
          # Check if tasks are stopped
          FRONTEND_RUNNING=$(aws ecs describe-services \
            --cluster stg-front \
            --services stg-front-service \
            --query 'services[0].runningCount' \
            --output text 2>/dev/null || echo "0")
          
          BACKEND_RUNNING=$(aws ecs describe-services \
            --cluster stg-api \
            --services stg-api-service \
            --query 'services[0].runningCount' \
            --output text 2>/dev/null || echo "0")
          
          echo "Frontend running tasks: $FRONTEND_RUNNING"
          echo "Backend running tasks: $BACKEND_RUNNING"
          
          if [ "$FRONTEND_RUNNING" = "0" ] && [ "$BACKEND_RUNNING" = "0" ]; then
            echo "âœ… å…¨ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢å®Œäº†"
          else
            echo "â³ ä¸€éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ãŒã¾ã åœæ­¢ä¸­..."
          fi

      - name: ğŸ“‹ Sleep Complete
        run: |
          echo ""
          echo "ğŸ‰ STGç’°å¢ƒåœæ­¢å®Œäº†!"
          echo "ğŸ’° ã‚³ã‚¹ãƒˆå‰Šæ¸›åŠ¹æœ:"
          echo "  - ECS Fargate: $0/æœˆ (åœæ­¢ä¸­)"
          echo "  - æ®‹å­˜ã‚³ã‚¹ãƒˆ: $5/æœˆ (RDSã€VPCç­‰)"
          echo ""
          echo "ğŸ“‹ CloudFlareè¨­å®šæ›´æ–°æ¨å¥¨:"
          echo "1. CloudFlareãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒ­ã‚°ã‚¤ãƒ³"
          echo "2. stg.smartao.jpã‚’ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒšãƒ¼ã‚¸ã«å¤‰æ›´"
          echo "3. ã¾ãŸã¯127.0.0.1ã«ãƒã‚¤ãƒ³ãƒˆ"
          echo ""
          echo "ğŸš€ æ¬¡å›èµ·å‹•æ–¹æ³•:"
          echo "GitHub Actions: 'STG Environment Wake Up' ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ"

  already-stopped:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.confirm_stop == 'false' }}
    steps:
      - name: â„¹ï¸ Stop Cancelled
        run: |
          echo "ğŸ”„ STGç’°å¢ƒåœæ­¢ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ"
          echo "ç¾åœ¨ã®ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„" 