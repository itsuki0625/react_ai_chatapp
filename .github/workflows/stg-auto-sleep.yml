name: STG Auto Sleep

on:
  workflow_dispatch:
    inputs:
      hours:
        description: 'ä½•æ™‚é–“å¾Œã«åœæ­¢ã™ã‚‹ã‹'
        required: true
        default: '4'
        type: choice
        options:
        - '1'
        - '2'
        - '4'
        - '8'
        - '12'
        - '24'
      purpose:
        description: 'åœæ­¢ç†ç”±'
        required: false
        type: string
        default: 'è‡ªå‹•åœæ­¢ã‚¿ã‚¤ãƒãƒ¼'

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  schedule-auto-sleep:
    runs-on: ubuntu-latest
    environment: Preview
    
    steps:
      - name: â° Auto Sleep Timer Start
        run: |
          echo "â° STGç’°å¢ƒè‡ªå‹•åœæ­¢ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹"
          echo "ğŸ• åœæ­¢äºˆå®šæ™‚åˆ»: $(date -d '+${{ github.event.inputs.hours }} hours' '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ“ åœæ­¢ç†ç”±: ${{ github.event.inputs.purpose }}"
          echo "ğŸ’° ã‚³ã‚¹ãƒˆå‰Šæ¸›: ${{ github.event.inputs.hours }}æ™‚é–“å¾Œã«è‡ªå‹•åœæ­¢"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ env.AWS_REGION }}

      - name: ğŸ” Verify STG is Running
        id: verify_running
        run: |
          echo "STGç’°å¢ƒã®å‹•ä½œçŠ¶æ…‹ã‚’ç¢ºèªä¸­..."
          
          # Frontend service status
          FRONTEND_COUNT=$(aws ecs describe-services \
            --cluster stg-front \
            --services stg-front-service \
            --query 'services[0].desiredCount' \
            --output text 2>/dev/null || echo "0")
          
          # Backend service status  
          BACKEND_COUNT=$(aws ecs describe-services \
            --cluster stg-api \
            --services stg-api-service \
            --query 'services[0].desiredCount' \
            --output text 2>/dev/null || echo "0")
          
          echo "Frontend desired count: $FRONTEND_COUNT"
          echo "Backend desired count: $BACKEND_COUNT"
          
          if [ "$FRONTEND_COUNT" = "1" ] && [ "$BACKEND_COUNT" = "1" ]; then
            echo "is_running=true" >> $GITHUB_OUTPUT
            echo "âœ… STGç’°å¢ƒã¯èµ·å‹•ä¸­ã§ã™ - è‡ªå‹•åœæ­¢ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹"
          else
            echo "is_running=false" >> $GITHUB_OUTPUT
            echo "ğŸ›‘ STGç’°å¢ƒã¯åœæ­¢ä¸­ã§ã™ - è‡ªå‹•åœæ­¢ã‚¿ã‚¤ãƒãƒ¼ä¸è¦"
            echo ""
            echo "ğŸ“‹ STGç’°å¢ƒã¯æ—¢ã«åœæ­¢ä¸­ã§ã™"
            echo "è‡ªå‹•åœæ­¢ã‚¿ã‚¤ãƒãƒ¼ã¯ä¸è¦ã§ã™"
            echo "ğŸš€ èµ·å‹•æ–¹æ³•: GitHub Actions > 'STG Environment Wake Up'"
            exit 0
          fi

      - name: â³ Wait for Scheduled Time
        if: steps.verify_running.outputs.is_running == 'true'
        run: |
          SLEEP_SECONDS=$((60 * 60 * ${{ github.event.inputs.hours }}))
          echo "â³ ${{ github.event.inputs.hours }}æ™‚é–“ ($SLEEP_SECONDSç§’) å¾…æ©Ÿä¸­..."
          echo "ğŸ• åœæ­¢äºˆå®šæ™‚åˆ»: $(date -d '+${{ github.event.inputs.hours }} hours' '+%Y-%m-%d %H:%M:%S')"
          
          # 1æ™‚é–“ã”ã¨ã«çŠ¶æ³ã‚’å ±å‘Š
          HOURS_REMAINING=${{ github.event.inputs.hours }}
          while [ $HOURS_REMAINING -gt 0 ]; do
            echo "â° æ®‹ã‚Š${HOURS_REMAINING}æ™‚é–“ã§STGç’°å¢ƒã‚’åœæ­¢ã—ã¾ã™"
            
            # 1æ™‚é–“å¾…æ©Ÿï¼ˆãŸã ã—æœ€å¾Œã®1æ™‚é–“æœªæº€ã®å ´åˆã¯æ®‹ã‚Šæ™‚é–“ã ã‘ï¼‰
            if [ $HOURS_REMAINING -eq 1 ]; then
              sleep $SLEEP_SECONDS
              break
            else
              sleep 3600  # 1æ™‚é–“
              HOURS_REMAINING=$((HOURS_REMAINING - 1))
              SLEEP_SECONDS=$((SLEEP_SECONDS - 3600))
            fi
          done
          
          echo "â° è‡ªå‹•åœæ­¢æ™‚åˆ»ã«åˆ°é”ã—ã¾ã—ãŸ"

      - name: ğŸ” Final Status Check
        if: steps.verify_running.outputs.is_running == 'true'
        id: final_check
        run: |
          echo "åœæ­¢å‰ã®æœ€çµ‚çŠ¶æ…‹ç¢ºèª..."
          
          # Frontend service status
          FRONTEND_COUNT=$(aws ecs describe-services \
            --cluster stg-front \
            --services stg-front-service \
            --query 'services[0].desiredCount' \
            --output text 2>/dev/null || echo "0")
          
          # Backend service status  
          BACKEND_COUNT=$(aws ecs describe-services \
            --cluster stg-api \
            --services stg-api-service \
            --query 'services[0].desiredCount' \
            --output text 2>/dev/null || echo "0")
          
          echo "Frontend desired count: $FRONTEND_COUNT"
          echo "Backend desired count: $BACKEND_COUNT"
          
          if [ "$FRONTEND_COUNT" = "1" ] && [ "$BACKEND_COUNT" = "1" ]; then
            echo "should_stop=true" >> $GITHUB_OUTPUT
            echo "âœ… STGç’°å¢ƒã¯èµ·å‹•ä¸­ã§ã™ - è‡ªå‹•åœæ­¢ã‚’å®Ÿè¡Œã—ã¾ã™"
          else
            echo "should_stop=false" >> $GITHUB_OUTPUT
            echo "ğŸ›‘ STGç’°å¢ƒã¯æ—¢ã«åœæ­¢æ¸ˆã¿ã§ã™ - è‡ªå‹•åœæ­¢ã‚’ã‚¹ã‚­ãƒƒãƒ—"
          fi

      - name: ğŸ›‘ Auto Stop ECS Services
        if: steps.final_check.outputs.should_stop == 'true'
        run: |
          echo "ğŸ›‘ è‡ªå‹•åœæ­¢å®Ÿè¡Œä¸­..."
          echo "â° åœæ­¢æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # Stop Frontend service
          echo "Frontend serviceåœæ­¢ä¸­..."
          aws ecs update-service \
            --cluster stg-front \
            --service stg-front-service \
            --desired-count 0
          
          # Stop Backend service
          echo "Backend serviceåœæ­¢ä¸­..."
          aws ecs update-service \
            --cluster stg-api \
            --service stg-api-service \
            --desired-count 0
          
          echo "âœ… è‡ªå‹•åœæ­¢ã‚³ãƒãƒ³ãƒ‰å®Œäº†"

      - name: ğŸ“‹ Auto Sleep Complete
        if: steps.verify_running.outputs.is_running == 'true'
        run: |
          echo ""
          echo "ğŸ‰ STGç’°å¢ƒè‡ªå‹•åœæ­¢å®Œäº†!"
          echo "â° åœæ­¢æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ“ åœæ­¢ç†ç”±: ${{ github.event.inputs.purpose }}"
          echo "ğŸ’° ã‚³ã‚¹ãƒˆå‰Šæ¸›åŠ¹æœ: ECS Fargateæ–™é‡‘ãŒ$0/æœˆã«ãªã‚Šã¾ã—ãŸ"
          echo ""
          echo "ğŸ“‹ CloudFlareè¨­å®šæ›´æ–°æ¨å¥¨:"
          echo "1. CloudFlareãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§stg.smartao.jpã‚’ç¢ºèª"
          echo "2. å¿…è¦ã«å¿œã˜ã¦ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒšãƒ¼ã‚¸ã«å¤‰æ›´"
          echo ""
          echo "ğŸš€ æ¬¡å›èµ·å‹•æ–¹æ³•:"
          echo "GitHub Actions: 'STG Environment Wake Up' ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ"

 