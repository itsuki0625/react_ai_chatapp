# 志望理由書添削機能 実装概要

## 設計思想

- **AIはアドバイザー**: AIエージェントは志望理由書を代筆するのではなく、学生が自身の力でより良い文章を書けるよう、あくまでアドバイスや改善提案を行う役割に徹する。学生の主体性を尊重し、思考力を養うことを目的とする。
- **インタラクティブな改善プロセス**: AIからの提案は一方的なものではなく、ユーザーが提案ごとに承認・拒否を選択できるUIを提供する。これにより、ユーザーは修正内容を吟味し、自身の文章表現を学ぶ機会を得られる。

## 現在実装されている機能

### 基本機能

1. **志望理由書の作成・編集・削除**
   - 新規志望理由書の作成
   - 既存志望理由書の編集
   - 志望理由書の削除
   - ドラフト版の保存機能

2. **志望理由書一覧管理**
   - ユーザー個人の志望理由書一覧表示
   - ステータス別の表示（下書き・レビュー中・レビュー済み・完成版）
   - 最終更新日・文字数などの基本情報表示

3. **志望理由書の詳細管理**
   - タイトル設定機能
   - 志望大学・学部との紐付け機能
   - キーワード管理（配列形式）
   - 提出期限設定

### 権限システム

1. **権限管理**
   - `statement_manage_own`: 自分の志望理由書を管理する権限
   - `statement_review_request`: 志望理由書のレビューを依頼する権限
   - `statement_review_respond`: 教員・管理者向けのレビュー対応権限
   - `statement_view_all`: 管理者向けの全ユーザー志望理由書閲覧権限

2. **有料機能化**
   - 志望理由書機能は有料プランユーザーのみ利用可能
   - 権限システムと連携した機能制限

### データベースモデル

1. **PersonalStatement（志望理由書）**
   - `id`: UUID（主キー）
   - `user_id`: ユーザーID
   - `desired_department_id`: 志望学部ID
   - `content`: 志望理由書本文
   - `status`: ステータス（draft/review/reviewed/final）
   - `title`: タイトル
   - `keywords`: キーワード配列
   - `submission_deadline`: 提出期限
   - `self_analysis_chat_id`: 自己分析チャットとの連携

2. **PersonalStatementSubmission（提出管理）**
   - 志望理由書の提出状況管理
   - 提出日時・提出者の記録

3. **Feedback（フィードバック）**
   - 教員・管理者からのフィードバック機能
   - フィードバック内容・作成者・作成日時

4. **PersonalStatementRevision（版管理）**
   - 志望理由書の版管理機能
   - 編集履歴・スナップショット保存
   - AI編集による変更履歴

5. **EvaluationResult（評価結果）**
   - AIによる評価結果保存
   - 評価エージェントID・採点表・アドバイス

6. **InAppNotification（アプリ内通知）**
   - 通知システムの基盤
   - 通知タイプ・タイトル・メッセージ・読了状態

### フロントエンド機能

1. **一覧画面（StatementListPage）**
   - 志望理由書カード形式表示
   - ステータス別色分け
   - 新規作成ボタン
   - 削除・編集アクション
   - フィードバック件数表示

2. **編集画面（StatementEditorPage）**
   - **Cursorライクな2ペイン構成**:
     - **左ペイン**: 志望理由書の本文を編集するリッチテキストエディタ。
     - **右ペイン**: AIと対話するためのチャットパネル。
   - **文章設定機能**: AIのコンテキストとなる「志望大学」や「自己分析チャット」を選択・変更するための専用画面（モーダル等）。
   - 複数チャットセッションの管理機能（新規作成、切り替え）。
   - ステータス管理。

3. **詳細画面**
   - 志望理由書の詳細表示
   - フィードバック一覧
   - 編集・削除アクション

4. **教師ダッシュボード（TeacherDashboardPage）**
   - 担当生徒の一覧表示
   - 添削リクエスト一覧表示（現在はモックデータを使用）
   - リクエストのステータス管理（未対応・添削中・完了）
   - 優先度別の表示（高・中・低）
   - 添削ボタンによるレビュー開始機能

### バックエンドAPI

1. **志望理由書CRUD操作**
   - `POST /api/v1/statements/`: 新規作成
   - `GET /api/v1/statements/`: 一覧取得
   - `GET /api/v1/statements/{id}/`: 詳細取得
   - `PUT /api/v1/statements/{id}/`: 更新
   - `DELETE /api/v1/statements/{id}/`: 削除

2. **フィードバック機能**
   - `POST /api/v1/statements/{id}/feedback/`: フィードバック作成
   - `GET /api/v1/statements/{id}/feedback/`: フィードバック一覧取得

3. **認証・権限チェック**
   - JWT認証によるユーザー識別
   - 権限ベースのアクセス制御
   - 所有者確認（自分の志望理由書のみ編集可能）

### 外部システム連携

1. **自己分析チャットとの連携**
   - 自己分析結果を志望理由書作成に活用
   - `self_analysis_chat_id`による参照

2. **志望校管理システムとの連携**
   - 志望大学・学部情報との紐付け
   - `desired_department_id`による関連付け

## 今後実装予定・検討中の機能

### インタラクティブAIチャットと編集機能

**目的**: Cursorのように、志望理由書を書きながら隣のパネルでAIと対話し、リアルタイムでアドバイスや修正案を得られる、シームレスな執筆体験を提供する。

**UI/UX設計**:
- **画面構成**: 画面を左右2つのペインに分割。
  - **左ペイン**: 志望理由書のエディタ。集中して執筆できる環境。
  - **右ペイン**: AIチャットパネル。ここでAIへの質問や改善依頼を行う。
- **チャット機能**:
  - **複数セッション**: ユーザーは複数の独立したチャットセッションを作成・管理できる。「ブレインストーミング用」「表現の洗練用」など、目的別にチャットを使い分けることが可能。
  - **コンテキスト連携**: チャットでの会話は、「文章設定」画面で指定された**志望大学・自己分析チャットの内容**と、現在編集中の志望理由書本文をコンテキストとして利用する。

**機能フロー**:
1. ユーザーはまず「文章設定」で、AIにインプットする志望大学と自己分析チャットを選択する。
2. ユーザーは左ペインで志望理由書を執筆する。
3. 右ペインのチャットで、AIに対して「この部分の表現をより良くしたい」「論理的な矛盾がないか確認してほしい」といった指示を出す。
4. AIはチャットで回答すると同時に、具体的な修正案を左ペインのエディタ上に「差分（diff）ビュー」として提示する。
5. ユーザーは提示された差分を確認し、提案ごとに「Accept（承認）」または「Reject（拒否）」を選択する。
6. 承認された修正だけが本文に反映される。

### 教師レビューリクエスト機能（部分実装）

**現在の実装状況:**

1. **実装済み部分**
   - 権限システム: `statement_review_request`と`statement_review_respond`権限
   - 基本的なフィードバック機能（教師から学生への）
   - 教師ダッシュボードのUI設計とモックデータ表示
   - 通知システムの基盤（InAppNotificationモデル）

2. **未実装部分**
   - **学生側レビューリクエスト送信機能**
     - 志望理由書編集画面からのレビュー依頼ボタン
     - レビュー依頼時のメッセージ入力機能
     - 優先度設定機能
   
   - **レビューリクエスト管理システム**
     - ReviewRequestデータベースモデル
     - リクエストステータス管理（pending/in_review/completed）
     - 依頼者・担当教師の紐付け管理
   
   - **バックエンドAPI**
     - `POST /api/v1/statements/{id}/review-request/`: レビュー依頼作成
     - `GET /api/v1/review-requests/`: 教師側リクエスト一覧取得
     - `PUT /api/v1/review-requests/{id}/status/`: リクエストステータス更新
     - `POST /api/v1/review-requests/{id}/assign/`: 教師アサイン機能
   
   - **リアルタイム通知システム**
     - 教師への新規レビューリクエスト通知
     - 学生への添削完了通知
     - アプリ内通知とメール通知の連携
   
   - **教師側レビュー処理機能**
     - レビューリクエストの受理・拒否機能
     - 添削中ステータス管理
     - 添削完了時の自動通知送信

**実装が必要なデータ構造:**
```typescript
interface ReviewRequest {
  id: string;
  personal_statement_id: string;
  student_id: string;
  teacher_id?: string; // 担当教師（未アサイン時はnull）
  status: 'pending' | 'assigned' | 'in_review' | 'completed' | 'rejected';
  priority: 'high' | 'medium' | 'low';
  message?: string; // 学生からの依頼メッセージ
  due_date?: string; // 希望期限
  assigned_at?: string; // アサイン日時
  started_at?: string; // 添削開始日時
  completed_at?: string; // 完了日時
  created_at: string;
  updated_at: string;
}
```

**実装予定の機能フロー:**
1. 学生が志望理由書編集画面で「レビュー依頼」ボタンをクリック
2. 依頼メッセージ・優先度・希望期限を入力
3. システムが利用可能な教師に通知を送信
4. 教師がレビューリクエストを受理・拒否
5. 受理された場合、添削作業を開始
6. 完了時に学生に通知とフィードバックを送信

### AI添削機能（準備中）

1. **AIによる改善提案とインタラクティブな編集UI**
   - **機能**: ユーザーがAIによる改善を要求すると、AIが文章の構成、表現、論理性を分析し、具体的な修正案を提示する。
   - **UI**: 提案はCursorのように、現在の文章と修正案を並べて表示する「差分（diff）ビュー」形式で提示される。
   - **アクション**: ユーザーは提案ごとに「Accept（承認）」または「Reject（拒否）」を選択できる。承認された修正のみが本文に反映される。
   - **API**: `POST /api/v1/statements/{id}/ai-improve/`

2. **AI評価システム**
   - EvaluationResultモデルによる評価結果保存
   - 採点基準に基づく自動評価
   - 改善アドバイスの生成

### テンプレート・例文機能（準備中）

1. **テンプレート提供**
   - `GET /api/v1/statements/templates/`: テンプレート一覧
   - 志望分野別のテンプレート

2. **例文参照**
   - `GET /api/v1/statements/examples/`: 例文一覧
   - 優秀な志望理由書の参考例

## 技術仕様

### 使用技術
- **バックエンド**: FastAPI + SQLAlchemy + PostgreSQL
- **フロントエンド**: Next.js + TypeScript + Tailwind CSS
- **認証**: NextAuth.js + JWT
- **状態管理**: React State + Custom Hooks

### セキュリティ対策
- JWT認証による安全なAPI呼び出し
- 所有者確認による不正アクセス防止
- 権限ベースのアクセス制御
- CORS設定による適切なオリジン制限

### パフォーマンス最適化
- データベースクエリ最適化（joinedload使用）
- ページネーション対応準備
- キャッシュ戦略（今後検討）

## 現在の制限事項

1. **AI添削機能は未実装**
   - APIエンドポイントは定義済みだが実装は未完了
   - 評価システムのデータベースモデルは準備済み

2. **テンプレート・例文機能は未実装**
   - APIエンドポイントは定義済みだが実装は未完了

3. **教師レビューリクエスト機能は部分実装**
   - 基本的なフィードバック機能は実装済み
   - 教師ダッシュボードのUIは実装済み（モックデータ使用）
   - 学生側からのレビュー依頼機能は未実装
   - レビューリクエスト管理システムは未実装
   - リアルタイム通知システムは未実装

4. **リアルタイム機能なし**
   - 自動保存機能は未実装
   - リアルタイム共同編集は未対応

5. **文字数制限・バリデーションの強化が必要**
   - 基本的なバリデーションは実装済み
   - より詳細な制限設定が必要

この志望理由書添削機能は、学生の志望理由書作成を包括的にサポートする設計になっており、基本的なCRUD操作から高度なAI添削、教師との連携まで段階的に機能を拡張できる構造になっています。特に教師レビューリクエスト機能は、権限システムと基本的なUI実装が完了しており、バックエンドAPIと連携機能の実装により完全な機能として提供可能です。
