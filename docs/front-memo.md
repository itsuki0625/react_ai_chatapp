# フロントエンド分析メモ

## 概要
study-support-appのフロントエンド分析結果をまとめたドキュメント。実装上の問題点とディレクトリ構成上の問題点を特定し、改善提案を含む。

---

## 1. 実装上の問題点

### 1.1 認証・セキュリティ関連
- **NextAuth設定の複雑性**: auth.tsで527行にわたる複雑な認証ロジック。トークンリフレッシュ、エラーハンドリング、型定義が混在している
- **API認証の重複実装**: API_BASE_URLとINTERNAL_API_BASE_URLの使い分けが不明確
- **トークン管理の複雑化**: accessTokenとrefreshTokenの管理ロジックが複数箇所に分散
- **セッション型安全性**: 複数の型アサーション（as any）が散見され、型安全性が低い

### 1.2 API層の問題
- **api-client.tsの肥大化**: 748行の巨大ファイルで、型定義、インターセプター、API関数が混在
- **型定義の重複**: インターフェースが複数箇所で重複定義されている
- **エラーハンドリングの不統一**: サービス層で異なるエラーハンドリング方法が混在
- **axios設定の複雑化**: インターセプターとカスタム認証ヘッダーの処理が過度に複雑

### 1.3 状態管理の問題
- **状態管理の分散**: Zustand、React Context、useSession等が混在し、統一性がない
- **空ファイルの存在**: `src/store/chat.ts`が空ファイルとして存在（未実装？）
- **グローバル状態の不整合**: 複数の状態管理ライブラリが並存している

### 1.4 TypeScriptの問題
- **型定義の分散**: 同じ概念の型が複数ファイルに分散定義されている
- **型安全性の欠如**: 必要な箇所での型アサーションが不足
- **インターフェースの重複**: User、Session関連の型が重複定義されている

### 1.5 パフォーマンス懸念
- **バンドルサイズ**: 多数のRadix UIコンポーネントとAxiosの重複使用
- **静的アセット**: 画像最適化の設定はあるが、未使用ファイルの整理が必要
- **レンダリング**: Client Componentが多用されており、SSRの恩恵が少ない

---

## 2. ディレクトリ構成上の問題点

### 2.1 app/ディレクトリの構造問題
- **グループ化の不整合**: `(app)`、`(auth)`グループが存在するが、teacherやadminは別階層に配置
- **深いネスト構造**: 一部のルートで過度に深いディレクトリ構造（例：`/chat/self-analysis/[sessionId]/components/`）
- **命名規則の不統一**: ハイフン（`self-analysis`）とアンダースコア混在

```
問題のある構造例:
app/
├── (app)/          # Route Group
├── (auth)/         # Route Group
├── admin/          # 通常ディレクトリ（Route Groupではない）
├── teacher/        # 通常ディレクトリ（Route Groupではない）
└── target-schools/ # 通常ディレクトリ（Route Groupではない）
```

### 2.2 components/ディレクトリの問題
- **機能別分割の不徹底**: 一部コンポーネントが用途別（admin、auth）、一部が機能別（chat、content）で分割
- **共通コンポーネントの混在**: common/とui/の使い分けが不明確
- **責任の分散**: layout/ディレクトリが別途存在し、UI構造の責任が分散

```
問題のある構造:
components/
├── admin/          # 機能別
├── auth/           # 機能別
├── chat/           # 機能別
├── common/         # 抽象度別
├── ui/             # 抽象度別
└── layout/         # 責任別
```

### 2.3 services/とlib/の重複
- **責任の重複**: services/とlib/api/で同様のAPI関連処理を実装
- **import pathの複雑化**: 関連する機能が複数ディレクトリに分散し、importが複雑
- **設定ファイルの分散**: API設定がlib/config.ts、services/api.ts等に分散

### 2.4 types/ディレクトリの問題
- **型定義の分散**: APIレスポンス型がapi-client.ts内部と/types/で重複定義
- **ファイル粒度の問題**: 1つのファイルが複数の概念を含む（例：api.tsが小さすぎる）

---

## 3. 改善提案

### 3.1 実装改善案
1. **認証モジュールの分離**: auth.tsを複数のモジュールに分割（config、handlers、types）
2. **API層の統一**: 単一のAPIクライアント設計とエラーハンドリングの統一化
3. **状態管理の統一**: Zustandに統一し、Context APIの使用を最小限に
4. **型定義の統一**: 型定義専用ディレクトリで一元管理

### 3.2 ディレクトリ構成改善案
```
推奨構造:
app/
├── (dashboard)/        # 統一されたRoute Group
│   ├── admin/
│   ├── teacher/
│   └── student/
├── (auth)/
│   ├── login/
│   └── signup/
└── (public)/
    └── landing/

components/
├── ui/                 # 基本UIコンポーネント
├── feature/            # 機能別コンポーネント
│   ├── auth/
│   ├── chat/
│   └── admin/
└── layout/             # レイアウト専用

lib/
├── api/                # API関連のみ
├── auth/               # 認証関連のみ
├── utils/              # ユーティリティ
└── constants/          # 定数

types/
├── api.ts              # API型定義
├── auth.ts             # 認証型定義
└── index.ts            # 型のエクスポート
```

### 3.3 技術的改善
1. **Code Splitting**: 動的インポートによる初期バンドルサイズ削減
2. **SSR対応**: Client Componentの使用を必要最小限に
3. **型安全性向上**: 型アサーション削減とstrict modeの活用
4. **エラーバウンダリ**: 適切なエラーハンドリング層の追加

---

## 4. 優先順位

### 高優先度
1. 認証モジュールのリファクタリング（セキュリティリスクあり）
2. API層の統一（開発効率に直結）
3. 型定義の統一（バグ予防）

### 中優先度
1. ディレクトリ構成の整理
2. 状態管理の統一
3. エラーハンドリングの改善

### 低優先度
1. パフォーマンス最適化
2. コード分割
3. 未使用ファイルの整理

---

## 5. まとめ
現在のフロントエンドは機能的には動作しているが、保守性、拡張性の観点で多くの改善点がある。特に認証周りの複雑性とディレクトリ構成の不整合は早急な対応が必要。
